
<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>T4 Memory APIs &mdash; T4 Developer Guide</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link href="../_static/jquery-ui.css" rel="stylesheet" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

      <link rel="shortcut icon" href="../_static/favicon.ico" />  
  
  
  <link rel="canonical" href="add the root doc url herememory.html" />
  

  
  
  
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  <script type="text/javascript" src="../_static/searchtools.js"></script>
  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
  <script type="text/javascript" src="../_static/js/theme.js"></script>
   
  
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Page Tree Navigation in T4" href="pagetree.html" />
    <link rel="prev" title="Using int_union" href="int_union.html" /> 
  

	<script>
    $(document).ready(function () {
      $(window).scroll(function () {
        if ($(this).scrollTop() >= 50) {
          $('.fixedbar, .wy-nav-side').addClass('scroll');
          $('.wy-top-menu-wrapper').fadeOut();
        } else {
          $('.fixedbar, .wy-nav-side').removeClass('scroll');
          $('.wy-top-menu-wrapper').fadeIn();
        }
      });
      $(window).scroll(function () {
        if ($(this).scrollTop() > 100) {
          $('#scroll').fadeIn();
        } else {
          $('#scroll').fadeOut();
        }
      });
      $('#scroll').click(function () {
        $("html, body").animate({ scrollTop: 0 }, 600);
        return false;
      });
    });
  </script>

<style>
  .wy-nav-content {max-width:90%}
  </style>
</head>

<body class="wy-body-for-nav">


  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
	  
	  	  
<!-- @@@@@@@@@@@@@@@@ Custom @@@@@@@@@@@@@@@@ -->
        <div class="wy-logo-wrapper">
          <a href="https://www.adobe.com">
            <img src="../_static/acrobaticon.png" class="logo"/>Adobe T4 Documentation</a>
        </div> 
 <!-- @@@@@@@@@@@@@@@@ Custom @@@@@@@@@@@@@@@@ -->
 
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> T4 Developer Guide
          

          
          </a>


          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="writingcppint4.html">C++ Best Practices for T4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="writingcppint4.html#the-most-important-thing">The Most Important Thing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#two-important-questions">Two Important Questions</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#let-s-not-kid-ourselves">Let’s Not Kid Ourselves</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writingcppint4.html#typographic-conventions">Typographic Conventions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#identifiers">Identifiers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#case-underbars">Case, Underbars</a></li>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#prefixing-suffixing">Prefixing/Suffixing</a></li>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#macros">Macros</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#tabs">Tabs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#xcode-and-tabs">Xcode and Tabs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#braces-indentation-and-carriage-returns">Braces, Indentation and Carriage Returns</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#parentheses">Parentheses</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writingcppint4.html#code-organization">Code Organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#file-organization">File Organization</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#writing-a-class">Writing a Class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#also-acceptable-raw-structs">Also Acceptable: Raw Structs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="writingcppint4.html#best-practices">Best Practices</a><ul>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#error-handling">Error Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#resource-acquisition-is-initialization-raii">Resource Acquisition Is Initialization (RAII)</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#return-values">Return Values</a><ul>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#multiple-return-values">Multiple Return Values</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#inheritance">Inheritance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="writingcppint4.html#the-override-keyword">The override keyword</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#shared-and-unique-pointers">Shared and Unique Pointers</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#namespaces">Namespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#integers">Integers</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#alphabetization">Alphabetization</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#platform-architecture-and-os-specific-code">Platform, Architecture and OS Specific Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="writingcppint4.html#geometry">Geometry</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="t4fileorganization.html">T4 File Organization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="t4fileorganization.html#about-header-files">About Header Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="t4fileorganization.html#where-everything-goes">Where Everything Goes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="t4fileorganization.html#about-detail-namespaces">About Detail Namespaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4fileorganization.html#implementation-headers">Implementation Headers</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4fileorganization.html#how-far-to-go-with-this">How Far to Go With This</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4fileorganization.html#going-even-farther">Going Even Farther</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="t4andexceptions.html">T4 and Exceptions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="t4andexceptions.html#but-let-s-not-kid-ourselves">But Let’s Not Kid Ourselves</a></li>
<li class="toctree-l2"><a class="reference internal" href="t4andexceptions.html#the-gruesome-details">The Gruesome Details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="t4testing.html">Testing T4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="t4testing.html#t4-test">t4-test</a><ul>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#building-t4-test">Building t4-test</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#first-steps">First steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#concepts">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#modes-of-execution">Modes of Execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#t4-test-on-ios"><code class="docutils literal notranslate"><span class="pre">t4-test</span></code> on iOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#performance">Performance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="t4testing.html#implementation-details-how-t4-test-measures-performance">Implementation Details: How t4-test Measures Performance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#output">Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#other-options">Other Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#other-t4-test-features">Other t4-test Features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="t4testing.html#rendering">Rendering</a></li>
<li class="toctree-l4"><a class="reference internal" href="t4testing.html#text-extraction">Text Extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="t4testing.html#document-info">Document Info</a></li>
<li class="toctree-l4"><a class="reference internal" href="t4testing.html#requesting-multiple-pages">Requesting Multiple Pages</a></li>
<li class="toctree-l4"><a class="reference internal" href="t4testing.html#accessibility-info-extraction">Accessibility Info Extraction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#tbd">TBD</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#cross-engine-comparison">Cross engine comparison</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#building-pdfium">Building PDFium</a></li>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#executing-t4-vs-pdfium-tests">Executing t4 vs pdfium tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="t4testing.html#t4x">t4x</a><ul>
<li class="toctree-l3"><a class="reference internal" href="t4testing.html#rationale">Rationale</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="helloworld.html">Hello World How Tos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#t4-projects">T4 Projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#writing-a-t4-client-in-xcode">Writing a T4 Client in Xcode</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#initialization-and-termination">Initialization and Termination</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#the-context-lock">The Context Lock</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#create-a-document-from-a-file-path">Create a document from a File Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#traverse-the-store-as-in-the-cos-api">Traverse the Store (as in the COS API)</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#extract-text">Extract Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#get-a-page-s-dimensions-and-rotation">Get a Page’s Dimensions and Rotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="helloworld.html#render-a-page">Render a Page</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cache.html">T4 Cache APIs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cache.html#cache-overview">Cache Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cache.html#example-factorization-cache">Example: Factorization Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#implementing-a-cache">Implementing a Cache</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cache.html#advanced-techniques">Advanced Techniques</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cache.html#caching-runtime-polymorphic-objects">Caching Runtime Polymorphic Objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#returning-a-different-key-from-the-requested-one">Returning a Different Key from the Requested One</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cache.html#notes-about-the-cache">Notes about the Cache</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cache.html#thread-safety">Thread Safety</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#const">Const</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#purging">Purging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cache.html#other-interesting-cache-features">Other Interesting Cache Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="cache.html#memory-thresholds">Memory Thresholds</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#computing-cached-object-sizes">Computing Cached Object Sizes</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#update-your-object-s-size">Update Your Object’s Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html#resource-pools">Resource Pools</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="draw.html">Drawing PDF with T4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="draw.html#using-display-event-stream">Using <code class="docutils literal notranslate"><span class="pre">display_event_stream</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data_store.html">Data Store</a><ul>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#data-block">data_block</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#id1">data_store</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#data-block-stream">data_block_stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#comparison-data-store-and-data-block-stream">Comparison: data_store and data_block_stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#creating-data-stores">Creating data_stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#creating-your-own-data-store">Creating Your Own data_store</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_store.html#creating-your-own-data-block-stream">Creating Your Own data_block_stream</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="int_union.html">Using int_union</a><ul>
<li class="toctree-l2"><a class="reference internal" href="int_union.html#xprogrammers-xset-theorists">∀x∈Programmers:x∈Set Theorists</a><ul>
<li class="toctree-l3"><a class="reference internal" href="int_union.html#the-int-union-template">The int_union Template</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="int_union.html#assignment-and-comparison">Assignment and Comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="int_union.html#integral-math">Integral Math</a></li>
<li class="toctree-l2"><a class="reference internal" href="int_union.html#integral-conversion">Integral Conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="int_union.html#performance-and-safety-considerations">Performance and Safety Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="int_union.html#correctness-implications-and-implementation-limits">Correctness Implications and Implementation Limits</a><ul>
<li class="toctree-l3"><a class="reference internal" href="int_union.html#the-special-template-parameters">The “Special” Template Parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">T4 Memory APIs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#a-quick-tour-of-t4-memory-facilities">A Quick Tour of T4 Memory Facilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memory-and-the-t4-cache">Memory and the T4 Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simple-allocation">Simple Allocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#smart-pointers-and-containers">Smart Pointers and Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-unique">make_unique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shared-ptr">shared_ptr</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#memory-usage">Memory Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#managing-memory-consumption">Managing Memory Consumption</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pagetree.html">Page Tree Navigation in T4</a><ul>
<li class="toctree-l2"><a class="reference internal" href="pagetree.html#choosing-the-right-type">Choosing the Right Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="pagetree.html#getting-from-one-type-to-another">Getting from One Type to Another</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="params.html">T4 Params Module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="params.html#problem-statement">Problem Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="params.html#approaches-to-solving-this-problem">Approaches to Solving this Problem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="params.html#parameter-structs">Parameter Structs</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#parameter-dictionaries">Parameter Dictionaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#parameter-soup">Parameter Soup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="params.html#using-t4-params">Using T4 Params</a><ul>
<li class="toctree-l3"><a class="reference internal" href="params.html#exposing-a-t4-params-based-api">Exposing a T4 Params-Based API</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#extracting-parameters-from-a-parameters-dictionary">Extracting Parameters from a Parameters Dictionary</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#invoking-a-t4-params-based-api">Invoking a T4 Params-Based API</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#evolving-a-t4-params-based-api">Evolving a T4 Params-Based API</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#compile-time-errors">Compile-Time Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#recommended-hybrid-approach">Recommended: Hybrid Approach</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#about-parameter-values">About Parameter Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#required-value-parameters">Required Value Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#required-reference-parameters">Required Reference Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#optional-parameters">Optional Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#required-parameters-with-default-values">Required Parameters with Default Values</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#parameter-descriptions-and-constexpr">Parameter Descriptions and constexpr</a></li>
<li class="toctree-l3"><a class="reference internal" href="params.html#abi-issues">ABI Issues</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tile_cache.html">Tile Cache</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tile_cache.html#the-basics">The Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#creating-a-pdf-tile-cache">Creating a pdf_tile_cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#controlling-a-pdf-tile-cache">Controlling a pdf_tile_cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#displaying-a-pdf-tile-cache-s-contents">Displaying a pdf_tile_cache’s Contents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tile_cache.html#pdf-tile-cache-details">pdf_tile_cache Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#tile-cache-requesters">Tile Cache Requesters</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#bitmaps">Bitmaps</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#defining-the-bitmap-type">Defining the Bitmap Type</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#drawing-parameters">Drawing Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#tile-collections">Tile Collections</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#pdf-tile-cache-implementation-and-theory">pdf_tile_cache Implementation and Theory</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#pdf-tile-cache-state">pdf_tile_cache State</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#about-painting-progress">About Painting Progress</a></li>
<li class="toctree-l3"><a class="reference internal" href="tile_cache.html#pile-tiles-implementation">pile_tiles Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="transient_heap.html">Transient Heap</a><ul>
<li class="toctree-l2"><a class="reference internal" href="transient_heap.html#quick-start">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="transient_heap.html#transient-heap-applications">transient_heap Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="transient_heap.html#grow-only-or-immutable-graphs-of-heterogeneous-objects">Grow-Only or Immutable Graphs of Heterogeneous Objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="transient_heap.html#algorithm-lifetime-bound-transient-allocations">Algorithm-Lifetime Bound Transient Allocations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="transient_heap.html#destruction-of-objects-in-a-transient-heap">Destruction of Objects in a transient_heap</a></li>
<li class="toctree-l2"><a class="reference internal" href="transient_heap.html#snapshots">Snapshots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="typed_bool.html">Typed Bool</a><ul>
<li class="toctree-l2"><a class="reference internal" href="typed_bool.html#existing-approaches">Existing Approaches</a><ul>
<li class="toctree-l3"><a class="reference internal" href="typed_bool.html#t4-typed-bool">t4::typed_bool</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

        <!--- @@@@@@@@@@@@@@@@ Custom @@@@@@@@@@@@@@@@ -->
        <div class="fixedbar">  
          <div class="wy-menu-items">
            
            <a href="../gettingstarted/index.html" class="topbarlink">Getting Started</a>  
            <a href="../developerguide/index.html" class="topbarlink">Developer Guide</a>  

          
          </div>  <!--
          <div class="sign-in">
            <a href="" class="btn btn-console">Jira or?</a>
            <a href="https://auth.services.adobe.com/en_US/index.html">Sign in?</a>
          </div>-->
        </div>
        <!--- @@@@@@@@@@@@@@@@ Custom @@@@@@@@@@@@@@@@ -->
   
      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">T4 Developer Guide</a>
        
      </nav>


      <div class="wy-nav-content">
      <a href="#" id="scroll" style="display:inline;"><span></span></a>
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>T4 Memory APIs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="pagetree.html" class="btn btn-neutral float-right" title="Page Tree Navigation in T4" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
        <a href="int_union.html" class="btn btn-neutral float-left" title="Using int_union" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="t4-memory-apis">
<h1>T4 Memory APIs<a class="headerlink" href="#t4-memory-apis" title="Permalink to this headline">¶</a></h1>
<p>Reference: <a class="reference external" href="https://wiki.corp.adobe.com/display/t4/T4+Memory+APIs">https://wiki.corp.adobe.com/display/t4/T4+Memory+APIs</a></p>
<p>T3 had a very useful memory management subsystem whereby it was easy for the client to control how much memory T3 used at any one time. Much of the memory consumed by T3 took the form of reference-counted cached objects, which could be purged if their ref count were exactly 1 and T3 was close to its maximum memory-consumption level as specified by the client.</p>
<p>T4 also has a memory management and cache subsystem with the following features:</p>
<ul class="simple">
<li><p>Memory thresholds just like T3</p></li>
<li><p>An API without app_traits or the ubiquitous context parameter</p></li>
<li><p>A first-class STL allocator built on top of T4’s cache-aware memory allocator</p></li>
<li><p>Several convenient template aliases for STL constructs atop T4</p></li>
<li><p>Caches now have the ability to understand different kinds of resources apart from global CPU heap memory (e.g., GPU memory)</p></li>
</ul>
<p>T4 does <strong>not</strong> implement a suballocator and does not attempt to do a better job of allocating memory than the OS – it simply forwards requests to ::malloc and ::free after doing a little bookkeeping.</p>
<p>The T4 memory API’s also do <em>not</em> require a ContextLock. You’re free to use them anywhere at any time, from any thread, inside or outside of a Runnable.</p>
<div class="section" id="a-quick-tour-of-t4-memory-facilities">
<h2>A Quick Tour of T4 Memory Facilities<a class="headerlink" href="#a-quick-tour-of-t4-memory-facilities" title="Permalink to this headline">¶</a></h2>
<div class="section" id="memory-and-the-t4-cache">
<h3>Memory and the T4 Cache<a class="headerlink" href="#memory-and-the-t4-cache" title="Permalink to this headline">¶</a></h3>
<p>T4’s memory allocation facilities are, like any other allocator, built up from primitive malloc/free functions. These primitives are forwarded directly to the OS’s native allocation routines. One important feature of the T4 allocator is that it communicates directly with the T4 cache to insure that, as allocation requests are satisfied, the cache is purged such that the total memory allocated by T4 is kept at or below a client-specified level if possible.</p>
<p>See the <a class="reference internal" href="cache.html"><span class="doc">T4 Cache APIs</span></a> for details.</p>
</div>
<div class="section" id="simple-allocation">
<h3>Simple Allocation<a class="headerlink" href="#simple-allocation" title="Permalink to this headline">¶</a></h3>
<p>Do you just need a block of memory? Use t4::malloc, t4::malloc_throw and t4::free:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Returns nullptr on failure</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="n">t4</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
<span class="n">t4</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>

<span class="c1">// Throws std::bad_alloc on failure</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="n">t4</span><span class="o">::</span><span class="n">malloc_throw</span><span class="p">(</span><span class="mi">2048</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span> <span class="c1">// impossible</span>
<span class="n">t4</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="smart-pointers-and-containers">
<h3>Smart Pointers and Containers<a class="headerlink" href="#smart-pointers-and-containers" title="Permalink to this headline">¶</a></h3>
<p>But of course you’d never write code like that. You’d use smart pointer classes like unique_ptr and shared_ptr, and containers like vector and map:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a shared pointer to an ogre with 50 marbles</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;</span> <span class="n">shared_ogre</span> <span class="o">=</span> <span class="n">t4</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

<span class="c1">// Create a unique pointer to an ogre with 10000 marbles</span>
<span class="n">t4</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;</span> <span class="n">o</span> <span class="o">=</span> <span class="n">t4</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>

<span class="c1">// Create an empty vector of unique_ptrs to ogres</span>
<span class="n">t4</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">t4</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;&gt;</span> <span class="n">ov</span><span class="p">;</span>

<span class="c1">// Push (and move) the ogre created above onto the vector</span>
<span class="n">ov</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">o</span><span class="p">));</span>

<span class="c1">// Create and push an ogre with 500 marbles onto the vector</span>
<span class="n">ov</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">t4</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>
</pre></div>
</div>
<p>In the t4 namespace, all of the following are literally just template aliases of their corresponding std classes, aliased so that the t4 allocator is used. For example:</p>
<p><strong>Samples from t4std.hpp</strong></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">t4</span> <span class="p">{</span>

<span class="c1">// T4-based model of the STL Allocator concept</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nc">allocator</span> <span class="o">:</span> <span class="p">...</span> <span class="n">base</span> <span class="n">classes</span> <span class="p">...</span>
<span class="p">{</span>
        <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>

        <span class="p">...</span> <span class="n">definitions</span> <span class="n">of</span> <span class="n">allocate</span><span class="p">,</span> <span class="n">deallocate</span><span class="p">,</span> <span class="n">rebind</span><span class="p">,</span> <span class="n">etc</span><span class="p">.</span> <span class="n">elided</span> <span class="p">...</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">TArgs</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">make_shared</span><span class="p">(</span><span class="n">TArgs</span><span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">allocate_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">TArgs</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">)...);</span>
<span class="p">}</span>

<span class="p">...</span> <span class="n">many</span> <span class="n">other</span> <span class="n">aliases</span><span class="o">/</span><span class="n">definitions</span> <span class="n">elided</span> <span class="p">...</span>
</pre></div>
</div>
<p>The following classes/functions are implemented/aliased in the t4 namespace and behave exactly as their std cognates:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/memory/allocator">allocator</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/string/basic_string">basic_string</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/string/basic_string">string</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/vector">vector</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/list">list</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/deque">deque</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/stack">stack</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/map">map</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/unordered_map">unordered_map</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/unordered_set">unordered_set</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/container/set">set</a></p></li>
<li><p><a class="reference external" href="http://www.boost.org/doc/libs/release/libs/dynamic_bitset/dynamic_bitset.html">dynamic_bitset</a></p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/memory/unique_ptr">unique_ptr</a></p></li>
<li><p>make_unique (not actually part of C++11, it’s in C++14 though)</p></li>
<li><p><a class="reference external" href="http://en.cppreference.com/w/cpp/memory/shared_ptr/make_shared">make_shared</a></p></li>
</ul>
</div>
<div class="section" id="make-unique">
<h3>make_unique<a class="headerlink" href="#make-unique" title="Permalink to this headline">¶</a></h3>
<p>make_unique is an important function which you should use whenever you allocate a single object on the heap.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not do the following:</p>
<p>t4::unique_ptr&lt;ogre&gt; o(new ogre(500)); // WRONG</p>
</div>
<p>This is an error that can’t be detected at compilation or even construction time, but will result in an assertion (in debug builds) and a crash (in release builds) when the unique_ptr goes out of scope. This is because t4::unique_ptr has a custom deleter, which destroys the object and releases its memory using t4::free. But unless you’ve overridden the default operator new, the memory in question was not allocated using t4::malloc.</p>
<p>You could solve this by overriding operator new/delete for the class, if you own the class’ implementation. But the better solution is to use make_unique instead of directly calling operator new:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">o</span> <span class="o">=</span> <span class="n">t4</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">ogre</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// GOOD</span>
</pre></div>
</div>
<p>Note that, unlike in the bad example, we can use auto here and save ourselves some redundant keystrokes. make_unique uses perfect forwarding – a new C++11 feature – to efficiently forward the parameters to the constructor.</p>
<p>In general, between t4::make_unique and t4::make_shared you should never have to use the new operator. Seriously. If you ever think you need to directly call new anything then you’re probably doing something wrong. Talk to Gordon if you think you need to call new.</p>
</div>
<div class="section" id="shared-ptr">
<h3>shared_ptr<a class="headerlink" href="#shared-ptr" title="Permalink to this headline">¶</a></h3>
<p>You might note that shared_ptr is not on the list above. That’s because shared_ptr does not take an Allocator template argument. In stark contrast to unique_ptr, shared_ptr’s deletion is handled polymorphically in its control block. If you want to create a std::shared_ptr whose memory is allocated with t4::allocator, all you need to do is use t4::make_shared. An instance of t4::allocator is stored in the std::shared_ptr’s control block, and it is used to delete the memory when the reference count drops to zero.</p>
</div>
</div>
<div class="section" id="memory-usage">
<h2>Memory Usage<a class="headerlink" href="#memory-usage" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="nf">total_allocated_memory</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
</pre></div>
</div>
<p>Returns the total number of bytes that have been allocated by calls to t4::malloc but not yet deallocated by t4::free.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="nf">peak_total_allocated_memory</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
</pre></div>
</div>
<p>Returns the largest value of total_allocated_memory since the last call to reset_peak_total_allocated_memory, or since the initialization of T4.</p>
</div>
<div class="section" id="managing-memory-consumption">
<h2>Managing Memory Consumption<a class="headerlink" href="#managing-memory-consumption" title="Permalink to this headline">¶</a></h2>
<p>You can easily control T4’s memory thresholds:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">t4</span><span class="o">::</span><span class="n">set_memory_thresholds</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">purge_threshold</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">purge_amount</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">fail_threshold</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tracking_cutoff_limit</span><span class="p">);</span>
</pre></div>
</div>
<p>Calling this function sets the three values that control the memory subsystem’s cache-related behavior. To recap:</p>
<p>T4 will always try to stay below <strong>purge_threshold</strong> total allocated bytes of memory. If it is about to attempt an allocation that would cause the total allocated amount to exceed purge_threshold, it will attempt a cache purge before proceeding. In this case it will purge at least <strong>purge_amount</strong> bytes, if possible.</p>
<p>Even if the cache was unable to purge below the desired threshold, it will still request memory from the OS – unless successful fulfillment of that request would cause total allocated memory to exceed <strong>fail_threshold</strong>. T4 will never allow the total amount of memory allocated through its allocator to exceed fail_threshold.</p>
<p>Setting fail_threshold to std::numeric_limits&lt;size_t&gt;::max() is a reasonable thing to do. It essentially means that T4 should not ever fail a call to t4::malloc unless the OS is literally out of memory–i.e., when the internal call to ::malloc returns nullptr.</p>
<p>There are client use cases where we don’t want especially large allocations to “count” against these various thresholds. For example, most renderings involve a large up-front allocation of memory for a pixel buffer. If a client doesn’t want large allocations like this to count against the purge threshold, they can set tracking_cutoff_limit to a large value. Allocations above this size won’t count against the purge threshold and won’t trigger a cache purge. This increases the burden on the client for memory management, but sometimes this is desirable. By default, tracking_cutoff_limit is std::numeric_limits&lt;size_t&gt;::max(), indicating that all allocations should be tracked.</p>
<p>Internally, set_memory_thresholds simply forwards the parameters to the global resource_pool that manages globally allocated CPU memory. See the cache documentation on resource pools.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Adobe Inc..
      <span class="lastupdated">
        Last update: Aug 30, 2021. 
        <img src="../_static/adobelogo.png" class="logo"/> 
      </span>

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>